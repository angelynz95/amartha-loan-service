# amartha-loan-service

- [Assumption](#assumption)
- [Scope](#scope)
- [Non-Scope](#non-scope)
- [Future Scope](#future-scope)
- [ERD](#erd)
  * [Loan](#loan)
  * [Loan Approval](#loan-approval)
  * [Investment](#investment)
  * [Disbursement](#disbursement)
- [State Diagram](#state-diagram)
- [Sequence Diagram](#sequence-diagram)
  * [Create Loan](#create-loan)
  * [Approve Loan](#approve-loan)
  * [Get Loans](#get-loans)
  * [Get Loan](#get-loan)
  * [Invest Loan](#invest-loan)
  * [Disburse Loan](#disburse-loan)

## Assumption
- There's no requirement about how the picture proof want to be stored when approving a loan, so I assume we can use link to the document.
- There's no requirement about how the signed agreement letter want to be stored when disbursing a loan, so I assume we can use link to the document.
- There's no requirement about sender of the email when loan state is invested, so I assume we can code the logic only and no email will be actually sent
- There's no requirement that ROI will be generated by system & no information of investment period, so I assume ROI is being set by client when creating a loan.
- There's no requirement about capability of an investor to invest multiple times to a specific loan, so I assume an investor can invest to each loan only once.

## Scope
- Create Loan
- Approve Loan
- Get Loans
- Get Loan
- Invest Loan
- Logic to send email when loan state is invested
- Disburse Loan

## Non-Scope
- Authentication & Authorization
- Employee & User Table
- Send real email

## Future Scope
- Send email using PubSub, instead of looping & sending them one by one in a single process. Purpose:
  - Scalability: Enabling the system to handle high email traffic efficiently by decoupling processing from execution.
  - Flexibility: Allowing seamless integration with different notification or email service in the future, without requiring major architectural changes.
- API ApproveLoan can accept picture proof in file format, then store it to Cloud Storage
- API DisburseLoan can accept signed agreement letter in file format, then store it to Cloud Storage

## ERD
```mermaid
erDiagram
    loans {
        bigint id PK
        bigint key UK
        string borrower_id_number
        double principal_amount
        double invested_amount
        double rate
        double roi
        string agreement_letter_link
        tinyint state
        int version
        string created_by
        datetime created_at
        string updated_by
        datetime updated_at
    }

    loan_approvals {
        bigint id PK
        bigint loan_key UK
        string approval_proof_link
        bigint validator_id
        date approval_date
        string created_by
        datetime created_at
        string updated_by
        datetime updated_at
    }

    investments {
        bigint id PK
        bigint key UK
        bigint loan_key
        double amount
        string investor_email
        string created_by
        datetime created_at
        string updated_by
        datetime updated_at
    }

    disbursements {
        bigint id PK
        bigint loan_key UK
        string signed_agreement_letter_link
        bigint field_officer_id
        date disbursement_date
        string created_by
        datetime created_at
        string updated_by
        datetime updated_at
    }

    loans ||--o| loan_approvals: has
    loans ||--o{ investments: has
    loans ||--o| disbursements: has
```

### Loan
Table
|Column|Data Type|Mandatory|Description|
|---|---|---|---|
|id|bigint|Y|PK, id, auto increment|
|key|bigint|Y|UK, key, generated by system|
|borrower_id_number|varchar(20)|Y|borrower id number|
|principal_amount|decimal(30,10)|Y|principal amount|
|invested_amount|decimal(30,10)|Y|invested amount, default zero|
|rate|decimal(5,2)|Y|rate|
|roi|decimal(30,10)|Y|roi (return of investment)|
|agreement_letter_link|bigint|Y|link to agreement letter|
|state|tinyint|Y|state, default 0<li>0 - PROPOSED</li><li>1 - APPROVED</li><li>2 - INVESTED</li><li>3 - DISBURSED</li>|
|version|int|Y|versioning, default 0|
|created_by|varchar(255)|Y|created by|
|created_at|datetime|Y|created at, default current_timestamp|
|updated_by|varchar(255)|N|updated by|
|updated_at|datetime|N|updated at, on update current_timestamp|

Index
|Index|Column|Unique|Description|
|---|---|---|---|
|id|id|Y|primary key on id|
|key|key|Y|unique key on key|

### Loan Approval
Table
|Column|Data Type|Mandatory|Description|
|---|---|---|---|
|id|bigint|Y|PK, id, auto increment|
|loan_key|bigint|Y|UK, reference to loan key|
|approval_proof_link|varchar(255)|Y|link to approval proof|
|validator_id|bigint|Y|validator employee id|
|approval_date|date|Y|approval date|
|created_by|varchar(255)|Y|created by|
|created_at|datetime|Y|created at, default current_timestamp|
|updated_by|varchar(255)|N|updated by|
|updated_at|datetime|N|updated at, on update current_timestamp|

Index
|Index|Column|Unique|Description|
|---|---|---|---|
|id|id|Y|primary key on id|
|loan_key|loan_key|Y|unique key on loan_key|

### Investment
Table
|Column|Data Type|Mandatory|Description|
|---|---|---|---|
|id|bigint|Y|PK, id, auto increment|
|key|bigint|Y|UK, key, generated by system|
|loan_key|bigint|Y|reference to loan key|
|amount|decimal(30,10)|Y|investment amount|
|investor_email|varchar(255)|Y|UK, key, generated by system|
|created_by|varchar(255)|Y|created by|
|created_at|datetime|Y|created at, default current_timestamp|
|updated_by|varchar(255)|N|updated by|
|updated_at|datetime|N|updated at, on update current_timestamp|

Index
|Index|Column|Unique|Description|
|---|---|---|---|
|id|id|Y|primary key on id|
|key|key|Y|unique key on key|
|idx_loan_key_investor_email|loan_key|Y|composite unique index on loan_key, investor_email|

### Disbursement
Table
|Column|Data Type|Mandatory|Description|
|---|---|---|---|
|id|bigint|Y|PK, id, auto increment|
|loan_key|bigint|Y|UK, reference to loan key|
|signed_agreement_letter_link|varchar(255)|Y|PK, id, auto increment|
|field_officer_id|bigint|Y|field officer employee id|
|disbursement_date|date|Y|disbursement date|
|created_by|varchar(255)|Y|created by|
|created_at|datetime|Y|created at, default current_timestamp|
|updated_by|varchar(255)|N|updated by|
|updated_at|datetime|N|updated at, on update current_timestamp|

Index
|Index|Column|Unique|Description|
|---|---|---|---|
|id|id|Y|primary key on id|
|loan_key|loan_key|Y|unique key on loan_key|

## State Diagram
```mermaid
stateDiagram
    [*] --> PROPOSED: loan is created
    PROPOSED --> APPROVED: loan is approved
    APPROVED --> INVESTED: total invested amount is equal to principal amount
    INVESTED --> DISBURSED: loan is given to borrower
    DISBURSED --> [*]
```

## Sequence Diagram

### Create Loan
```mermaid
sequenceDiagram
    autonumber

    participant client as Client
    participant loan as Loan Service
    participant db as DB

    client->>+loan: create loan

    loan->>loan: decode request
    opt decode error or missing required key(s)
        loan--xclient: error response<br/>400 Bad Request
    end

    loan->>loan: validate request data
    opt invalid request data
        loan--xclient: error response<br/>422 Unprocessable Entity
    end

    loan->>+db: insert loan with state PROPOSED
    db-->>-loan: result
    opt error
        loan--xclient: error response<br/>500 Internal Server Error
    end

    loan-->>-client: success response<br>200 OK
```

### Approve Loan
```mermaid
sequenceDiagram
    autonumber

    participant client as Client
    participant loan as Loan Service
    participant db as DB

    client->>+loan: approve loan

    loan->>loan: decode request
    opt decode error or missing required key(s)
        loan--xclient: error response<br/>400 Bad Request
    end

    loan->>loan: validate request data
    opt invalid request data
        loan--xclient: error response<br/>422 Unprocessable Entity
    end

    loan->>+db: inquiry loan by key
    db-->>-loan: loan
    opt error
        loan--xclient: error response<br/>500 Internal Server Error
    end

    loan->>loan: validate loan data
    note over loan: loan state must be PROPOSED
    opt invalid loan data
        loan--xclient: error response<br/>422 Unprocessable Entity
    end

    critical atomic
        loan->>+db: update loan by key & version<br>set state = APPROVED<br>& version = current version + 1
        db-->>-loan: result

        loan->>+db: insert loan_approval
        db-->>-loan: result
    end
    opt error
        loan--xclient: error response<br/>500 Internal Server Error
    end

    loan-->>-client: success response<br>200 OK
```

### Get Loans
```mermaid
sequenceDiagram
    autonumber

    participant client as Client
    participant loan as Loan Service
    participant db as DB

    client->>+loan: get loans

    loan->>loan: decode request
    opt decode error or missing required key(s)
        loan--xclient: error response<br/>400 Bad Request
    end

    loan->>loan: validate request data
    opt invalid request data
        loan--xclient: error response<br/>422 Unprocessable Entity
    end

    loan->>+db: inquiry loans by filter & pagination
    db-->>-loan: loans
    opt error
        loan--xclient: error response<br/>500 Internal Server Error
    end

    loan->>loan: build list response

    loan-->>-client: success response<br>200 OK
```

### Get Loan
```mermaid
sequenceDiagram
    autonumber

    participant client as Client
    participant loan as Loan Service
    participant db as DB

    client->>+loan: get loan

    loan->>loan: decode request
    opt decode error or missing required key(s)
        loan--xclient: error response<br/>400 Bad Request
    end

    loan->>loan: validate request data
    opt invalid request data
        loan--xclient: error response<br/>422 Unprocessable Entity
    end

    loan->>+db: inquiry loan by key
    db-->>-loan: loan
    opt error
        loan--xclient: error response<br/>500 Internal Server Error
    end

    loan->>loan: build detail response

    loan-->>-client: success response<br>200 OK
```

### Invest Loan
```mermaid
```

### Disburse Loan
```mermaid
```
